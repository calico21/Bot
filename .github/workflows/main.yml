name: QuantBot Workflow

on:
  schedule:
    # 1. Daily Tracker: 21:30 UTC (Mon-Fri)
    # Runs after market close to update the dashboard/CSV
    - cron: '30 21 * * 1-5'
    
    # 2. Rebalance Check: 14:30 UTC (Mon-Fri)
    # Runs EVERY weekday. Python decides if it's the "First Trading Day".
    # (Winter: 9:30 AM ET / Summer: 10:30 AM ET)
    - cron: '30 15 * * 1-5'

  workflow_dispatch: # Allows manual button click

permissions:
  contents: write # REQUIRED to save CSVs/Images

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.13'
          
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          
      - name: Run Bot (Smart Scheduler)
        env:
          ALPACA_API_KEY: ${{ secrets.ALPACA_API_KEY }}
          ALPACA_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # Get current Hour (H)
          H=$(date +%H)

          # --- LOGIC UPDATE ---
          # We removed the [ "$D" == "01" ] check.
          # We now run every weekday and trust execution.py to check the calendar.

          if [ "$H" == "14" ] || [ "$H" == "15" ]; then
             echo "‚òÄÔ∏è Morning Run (Hour $H UTC). Checking if today is Rebalance Day..."
             # This script will now check is_rebalance_day().
             # If FALSE -> It exits safely.
             # If TRUE  -> It executes the trades.
             python execution.py
             
          elif [ "$H" == "21" ]; then
             echo "üåô Evening Run. Updating Tracker..."
             python execution.py --track
             
          else
             echo "‚ö†Ô∏è Manual Run. Defaulting to Tracker."
             python execution.py --track
          fi

      - name: Commit and Push Data
        run: |
          git config --global user.name "QuantBot"
          git config --global user.email "bot@quant.com"
          git add trade_history.csv live_performance.csv live_dashboard.png || true
          git commit -m "üìà Auto-update: Portfolio Tracker & Logs" || echo "No changes to commit"
          git push
