name: QuantBot Workflow

on:
  schedule:
    # 1. Daily Tracker: 21:30 UTC 
    # (Winter: 30 mins after close. Summer: 1h 30m after close. ALWAYS SAFE.)
    - cron: '30 21 * * 1-5' 
    
    # 2. Rebalance Attempt A: 14:30 UTC 
    # (Summer: 10:30 AM ET -> SAFE. Winter: 9:30 AM ET -> TOO EARLY, Script will skip.)
    - cron: '30 14 1 * *' 
    
    # 3. Rebalance Attempt B: 15:30 UTC
    # (Summer: 11:30 AM ET -> ALREADY TRADED, Script will skip. Winter: 10:30 AM ET -> SAFE.)
    - cron: '30 15 1 * *'

  workflow_dispatch: # Allows manual button click

permissions:
  contents: write # REQUIRED to save the CSV and Graph back to the repo

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.13'
          
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          
      - name: Run Bot (Smart Scheduler)
        env:
          ALPACA_API_KEY: ${{ secrets.ALPACA_API_KEY }}
          ALPACA_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # Get current Hour (H) and Day (D)
          H=$(date +%H)
          D=$(date +%d)

          # LOGIC:
          # If Day is 01 AND Hour is 14 or 15 (UTC) -> Try Rebalance
          if [ "$D" == "01" ] && ( [ "$H" == "14" ] || [ "$H" == "15" ] ); then
            echo "üìÖ Monthly Rebalance Window (Hour $H UTC). Checking Market Status..."
            python execution.py
            
          # Else if Hour is 21 (UTC) -> Run Tracker
          elif [ "$H" == "21" ]; then
            echo "üìä Daily Tracker Run."
            python execution.py --track
            
          else
             echo "‚ö†Ô∏è Manual Run or Unknown Trigger. Running Tracker by default."
             python execution.py --track
          fi

      # CRITICAL STEP: Commit the updated CSV and Graph back to GitHub
      # Without this, your "Live Tracker" forgets everything every day!
      - name: Commit and Push Data
        run: |
          git config --global user.name "QuantBot"
          git config --global user.email "bot@quant.com"
          
          # Add the specific files we want to save
          git add trade_history.csv live_performance.csv live_dashboard.png || true
          
          # Commit if there are changes
          git commit -m "üìà Auto-update: Portfolio Tracker & Logs" || echo "No changes to commit"
          
          # Push back to repo
          git push
